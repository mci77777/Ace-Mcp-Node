name: Build Prompt Enhance Electron

on:
  push:
    tags:
      - 'prompt-enhance-v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 0.1.0)'
        required: false
        default: '0.1.0'

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build shared package
        run: npm run build -w @codebase-mcp/shared
      
      - name: Build prompt-enhance package
        run: npm run build:electron -w @codebase-mcp/prompt-enhance
      
      - name: Verify build output
        shell: pwsh
        run: |
          if (Test-Path "packages/prompt-enhance/dist/web/templates/index.html") {
            Write-Host "âœ“ Build output generated successfully" -ForegroundColor Green
            Write-Host "Templates directory:" -ForegroundColor Cyan
            Get-ChildItem "packages/prompt-enhance/dist/web/templates" | Format-Table Name, Length
          } else {
            Write-Host "âœ— Build output not found" -ForegroundColor Red
            exit 1
          }
      
      - name: Package Electron app (Windows)
        run: npm run package:electron:win -w @codebase-mcp/prompt-enhance
      
      - name: List build artifacts
        shell: pwsh
        run: |
          Write-Host "Build artifacts:" -ForegroundColor Cyan
          Get-ChildItem -Path "packages/prompt-enhance/build/electron" -Recurse -File | 
            Where-Object { $_.Extension -in @('.exe', '.zip', '.7z') } | 
            Format-Table Name, @{Label="Size (MB)"; Expression={[math]::Round($_.Length/1MB, 2)}}
      
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            packages/prompt-enhance/build/electron/*.exe
            packages/prompt-enhance/build/electron/**/*.exe
          retention-days: 7
      
      - name: Create Release (if tag)
        if: startsWith(github.ref, 'refs/tags/prompt-enhance-v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            packages/prompt-enhance/build/electron/*.exe
            packages/prompt-enhance/build/electron/**/*.exe
          draft: false
          prerelease: false
          name: Prompt Enhance ${{ github.ref_name }}
          body: |
            ## ğŸš€ Prompt Enhance - Electron Desktop App
            
            ### ğŸ“¥ ä¸‹è½½
            
            **Windows å®‰è£…ç‰ˆ**:
            - `Prompt Enhance-*-win-x64.exe` - å®Œæ•´å®‰è£…ç¨‹åºï¼ˆæ¨èï¼‰
            
            **Windows ä¾¿æºç‰ˆ**:
            - `Prompt Enhance-*-portable.exe` - æ— éœ€å®‰è£…ï¼Œè§£å‹å³ç”¨
            
            ### âœ¨ åŠŸèƒ½ç‰¹æ€§
            
            - âœ… åŸç”Ÿæ¡Œé¢åº”ç”¨ï¼ˆæ— éœ€æµè§ˆå™¨ï¼‰
            - âœ… å†…åµŒ Web UI
            - âœ… è‡ªåŠ¨æŸ¥æ‰¾å¯ç”¨ç«¯å£
            - âœ… æç¤ºè¯å¢å¼ºæœåŠ¡
            - âœ… é¡¹ç›®æ–‡ä»¶æ‰«æ
            - âœ… å¤šæ¨¡å‹æ”¯æŒ
            - âœ… å®æ—¶æ—¥å¿—æŸ¥çœ‹
            - âœ… é…ç½®ç®¡ç†ç•Œé¢
            
            ### ğŸ”§ ä½¿ç”¨æ–¹æ³•
            
            **å®‰è£…ç‰ˆ**:
            1. ä¸‹è½½ `Prompt Enhance-*-win-x64.exe`
            2. åŒå‡»è¿è¡Œå®‰è£…ç¨‹åº
            3. æŒ‰ç…§å‘å¯¼å®Œæˆå®‰è£…
            4. ä»å¼€å§‹èœå•æˆ–æ¡Œé¢å¿«æ·æ–¹å¼å¯åŠ¨
            
            **ä¾¿æºç‰ˆ**:
            1. ä¸‹è½½ `Prompt Enhance-*-portable.exe`
            2. æ”¾åˆ°ä»»æ„ç›®å½•
            3. åŒå‡»è¿è¡Œ
            
            ### âš™ï¸ é…ç½®
            
            é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨åˆ›å»ºé…ç½®æ–‡ä»¶ï¼š
            ```
            %USERPROFILE%\.codebase-mcp\settings.toml
            ```
            
            å¯ä»¥åœ¨åº”ç”¨å†…çš„"é…ç½®"é¡µé¢ä¿®æ”¹è®¾ç½®ã€‚
            
            ### ğŸ› æ•…éšœæ’é™¤
            
            å¦‚æœé‡åˆ°é—®é¢˜ï¼š
            
            1. **çª—å£æ˜¾ç¤ºç©ºç™½**
               - è®¿é—® `http://localhost:8090/debug` æŸ¥çœ‹è¯Šæ–­ä¿¡æ¯
            
            2. **ç«¯å£è¢«å ç”¨**
               - åº”ç”¨ä¼šè‡ªåŠ¨å°è¯•ä¸‹ä¸€ä¸ªå¯ç”¨ç«¯å£ï¼ˆ8091, 8090...ï¼‰
            
            3. **æŸ¥çœ‹æ—¥å¿—**
               - æ—¥å¿—ä½ç½®ï¼š`%USERPROFILE%\.codebase-mcp\log\codebase-mcp.log`
            
            è¯¦ç»†æ–‡æ¡£ï¼š[TROUBLESHOOTING.md](https://github.com/${{ github.repository }}/blob/main/packages/prompt-enhance/TROUBLESHOOTING.md)
            
            ### ğŸ“ æ›´æ–°æ—¥å¿—
            
            #### æ–°åŠŸèƒ½
            - å¢å¼ºçš„è·¯å¾„è§£æé€»è¾‘ï¼Œæ”¯æŒå¤šç§ç¯å¢ƒ
            - æ–°å¢ `/debug` è°ƒè¯•é¡µé¢
            - è¯¦ç»†çš„è¯Šæ–­æ—¥å¿—
            - æ”¹è¿›çš„é”™è¯¯æç¤º
            
            #### ä¿®å¤
            - âœ… ä¿®å¤æ‰“åŒ…å Web UI ç©ºç™½é—®é¢˜
            - âœ… ä¼˜åŒ–é™æ€èµ„æºåŠ è½½
            - âœ… æ”¹è¿›è·¯å¾„è§£æå…¼å®¹æ€§
            
            ---
            **ç‰ˆæœ¬**: `${{ github.ref_name }}`  
            **æäº¤**: `${{ github.sha }}`  
            **æ„å»ºæ—¶é—´**: `${{ github.event.head_commit.timestamp }}`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build shared package
        run: npm run build -w @codebase-mcp/shared
      
      - name: Build prompt-enhance package
        run: npm run build:electron -w @codebase-mcp/prompt-enhance
      
      - name: Package Electron app (macOS)
        run: npm run package:electron:mac -w @codebase-mcp/prompt-enhance
      
      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            packages/prompt-enhance/build/electron/*.dmg
            packages/prompt-enhance/build/electron/*.zip
          retention-days: 7
      
      - name: Upload to Release (if tag)
        if: startsWith(github.ref, 'refs/tags/prompt-enhance-v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            packages/prompt-enhance/build/electron/*.dmg
            packages/prompt-enhance/build/electron/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build shared package
        run: npm run build -w @codebase-mcp/shared
      
      - name: Build prompt-enhance package
        run: npm run build:electron -w @codebase-mcp/prompt-enhance
      
      - name: Package Electron app (Linux)
        run: npm run package:electron:linux -w @codebase-mcp/prompt-enhance
      
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            packages/prompt-enhance/build/electron/*.AppImage
            packages/prompt-enhance/build/electron/*.deb
          retention-days: 7
      
      - name: Upload to Release (if tag)
        if: startsWith(github.ref, 'refs/tags/prompt-enhance-v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            packages/prompt-enhance/build/electron/*.AppImage
            packages/prompt-enhance/build/electron/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
