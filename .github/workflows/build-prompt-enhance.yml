name: Build Prompt Enhance

on:
  push:
    tags:
      - 'prompt-enhance-v*'

jobs:
  build-electron:
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build shared package
        run: npm run build:shared
      
      - name: Build Electron app
        run: npm run build:electron -w @codebase-mcp/prompt-enhance
      
      - name: Package Electron app (Windows)
        if: matrix.os == 'windows-latest'
        run: npm run package:electron:win -w @codebase-mcp/prompt-enhance
      
      - name: Package Electron app (macOS)
        if: matrix.os == 'macos-latest'
        run: npm run package:electron:mac -w @codebase-mcp/prompt-enhance
      
      - name: Package Electron app (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: npm run package:electron:linux -w @codebase-mcp/prompt-enhance
      
      - name: Verify build output (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          if (Test-Path "packages/prompt-enhance/build/electron/Prompt Enhance-*-win-x64.exe") {
            Write-Host "âœ“ Windows installer generated successfully"
            $installer = Get-Item "packages/prompt-enhance/build/electron/Prompt Enhance-*-win-x64.exe"
            Write-Host "Installer size: $([math]::Round($installer.Length / 1MB, 2)) MB"
          }
          if (Test-Path "packages/prompt-enhance/build/electron/Prompt Enhance-*-portable.exe") {
            Write-Host "âœ“ Portable exe generated successfully"
            $portable = Get-Item "packages/prompt-enhance/build/electron/Prompt Enhance-*-portable.exe"
            Write-Host "Portable size: $([math]::Round($portable.Length / 1MB, 2)) MB"
          }
        shell: pwsh
      
      - name: Verify build output (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          if [ -f packages/prompt-enhance/build/electron/*.dmg ]; then
            echo "âœ“ macOS DMG generated successfully"
            ls -lh packages/prompt-enhance/build/electron/*.dmg
          fi
      
      - name: Verify build output (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          if [ -f packages/prompt-enhance/build/electron/*.AppImage ]; then
            echo "âœ“ Linux AppImage generated successfully"
            ls -lh packages/prompt-enhance/build/electron/*.AppImage
          fi
      
      - name: Upload artifacts (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v3
        with:
          name: windows-builds
          path: |
            packages/prompt-enhance/build/electron/*.exe
            packages/prompt-enhance/build/electron/*.blockmap
      
      - name: Upload artifacts (macOS)
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v3
        with:
          name: macos-builds
          path: |
            packages/prompt-enhance/build/electron/*.dmg
            packages/prompt-enhance/build/electron/*.zip
      
      - name: Upload artifacts (Linux)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v3
        with:
          name: linux-builds
          path: |
            packages/prompt-enhance/build/electron/*.AppImage
            packages/prompt-enhance/build/electron/*.deb
  
  release:
    needs: build-electron
    runs-on: ubuntu-latest
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            windows-builds/*
            macos-builds/*
            linux-builds/*
          draft: false
          prerelease: false
          name: Prompt Enhance ${{ github.ref_name }}
          body: |
            ## Prompt Enhance - çœŸæ­£çš„æ¡Œé¢åº”ç”¨
            
            åŸºäº Electron æ„å»ºçš„åŸç”Ÿæ¡Œé¢åº”ç”¨ï¼Œå†…åµŒ Web UIï¼Œæ— éœ€æµè§ˆå™¨ã€‚
            
            ### ğŸ“¦ ä¸‹è½½
            
            **Windows**:
            - `Prompt Enhance-x.x.x-win-x64.exe` - å®‰è£…ç¨‹åºï¼ˆæ¨èï¼‰
            - `Prompt Enhance-x.x.x-portable.exe` - ä¾¿æºç‰ˆï¼ˆå…å®‰è£…ï¼‰
            
            **macOS**:
            - `Prompt Enhance-x.x.x.dmg` - macOS å®‰è£…åŒ…
            
            **Linux**:
            - `Prompt Enhance-x.x.x.AppImage` - Linux åº”ç”¨é•œåƒ
            - `Prompt Enhance-x.x.x.deb` - Debian/Ubuntu åŒ…
            
            ### ğŸš€ å¿«é€Ÿå¼€å§‹
            
            1. ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
            2. åŒå‡»è¿è¡Œï¼ˆWindows/macOSï¼‰æˆ– `chmod +x` åè¿è¡Œï¼ˆLinuxï¼‰
            3. åº”ç”¨ä¼šè‡ªåŠ¨æ‰“å¼€çª—å£ï¼Œæ— éœ€æµè§ˆå™¨
            4. åœ¨ UI ä¸­é…ç½® API è®¾ç½®
            
            ### ğŸ“ é…ç½®
            
            - é…ç½®æ–‡ä»¶: `~/.codebase-mcp/settings.toml`
            - æ—¥å¿—ç›®å½•: `~/.codebase-mcp/log/`
            
            ### âœ¨ ç‰¹æ€§
            
            - ğŸ–¥ï¸ åŸç”Ÿæ¡Œé¢åº”ç”¨ï¼ˆElectronï¼‰
            - ğŸ¨ å†…åµŒ Web UIï¼ˆæ— éœ€æµè§ˆå™¨ï¼‰
            - ğŸ¤– AI æç¤ºè¯å¢å¼º
            - ğŸ“ é¡¹ç›®ä¸Šä¸‹æ–‡é›†æˆ
            - ğŸ”„ å®æ—¶é¢„è§ˆ
            - ğŸŒ å¤šè¯­è¨€æ”¯æŒ
            
            ### ğŸ“– æ–‡æ¡£
            
            è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·æŸ¥çœ‹ [README.md](https://github.com/${{ github.repository }}/blob/main/packages/prompt-enhance/README.md)
            
            ---
            **Tag**: `${{ github.ref_name }}`  
            **Commit**: `${{ github.sha }}`  
            **Electron**: v39.2.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
