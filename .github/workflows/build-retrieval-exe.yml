name: Build Retrieval EXE

on:
  push:
    tags:
      - 'retrieval-exe-v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 0.1.0)'
        required: false
        default: '0.1.0'

jobs:
  build-windows:
    name: Build Windows EXE
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build shared package
        run: npm run build -w @codebase-mcp/shared
      
      - name: Build retrieval bundle
        run: npm run build:bundle -w @codebase-mcp/retrieval
      
      - name: Verify bundle output
        shell: pwsh
        run: |
          if (Test-Path "packages/retrieval/dist/bundle.cjs") {
            Write-Host "âœ“ Bundle created successfully" -ForegroundColor Green
            $size = [math]::Round((Get-Item "packages/retrieval/dist/bundle.cjs").Length/1MB, 2)
            Write-Host "  Size: $size MB" -ForegroundColor Cyan
          } else {
            Write-Host "âœ— Bundle not found" -ForegroundColor Red
            exit 1
          }
      
      - name: Package with pkg
        run: npm run package:pkg -w @codebase-mcp/retrieval
      
      - name: Verify exe output
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Path "packages/retrieval/build/pkg" -Filter "*.exe" | Select-Object -First 1
          if ($exe) {
            Write-Host "âœ“ EXE created successfully" -ForegroundColor Green
            Write-Host "  Name: $($exe.Name)" -ForegroundColor Cyan
            Write-Host "  Size: $([math]::Round($exe.Length/1MB, 2)) MB" -ForegroundColor Cyan
            Write-Host "  Path: $($exe.FullName)" -ForegroundColor Gray
          } else {
            Write-Host "âœ— EXE not found" -ForegroundColor Red
            exit 1
          }
      
      - name: Test exe execution
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Path "packages/retrieval/build/pkg" -Filter "*.exe" | Select-Object -First 1
          Write-Host "Testing exe: $($exe.FullName)" -ForegroundColor Yellow
          
          # Test that exe can start (will fail without MCP client, but should not crash)
          $proc = Start-Process -FilePath $exe.FullName -PassThru -NoNewWindow
          Start-Sleep -Seconds 2
          
          if ($proc.HasExited) {
            Write-Host "âš  Process exited (expected without MCP client)" -ForegroundColor Yellow
          } else {
            Write-Host "âœ“ Process started successfully" -ForegroundColor Green
            Stop-Process -Id $proc.Id -Force
          }
      
      - name: Create portable package
        shell: pwsh
        run: |
          $buildDir = "packages/retrieval/build/pkg"
          $portableDir = "packages/retrieval/build/portable"
          
          # Create portable directory
          New-Item -ItemType Directory -Path $portableDir -Force | Out-Null
          
          # Copy exe
          $exe = Get-ChildItem -Path $buildDir -Filter "*.exe" | Select-Object -First 1
          Copy-Item -Path $exe.FullName -Destination "$portableDir/codebase-retrieval.exe"
          
          # Copy install script
          Copy-Item -Path "packages/retrieval/scripts/install-windows.ps1" -Destination "$portableDir/"
          
          # Create README
          @"
# Codebase Retrieval - Windows Portable

## å¿«é€Ÿå¼€å§‹

### æ–¹æ³• 1ï¼šç›´æ¥ä½¿ç”¨ï¼ˆæ— éœ€å®‰è£…ï¼‰

```bash
.\codebase-retrieval.exe
```

### æ–¹æ³• 2ï¼šå®‰è£…åˆ°ç³»ç»Ÿï¼ˆæ¨èï¼‰

ä»¥ç®¡ç†å‘˜æƒé™è¿è¡Œ PowerShellï¼š

```powershell
.\install-windows.ps1
```

å®‰è£…åå¯åœ¨ä»»æ„ä½ç½®ä½¿ç”¨ `codebase-retrieval` å‘½ä»¤ã€‚

## MCP é…ç½®

**Claude Desktop** (`%APPDATA%\Claude\claude_desktop_config.json`):

```json
{
  "mcpServers": {
    "codebase-retrieval": {
      "command": "codebase-retrieval"
    }
  }
}
```

**Kiro** (`.kiro/settings/mcp.json`):

```json
{
  "mcpServers": {
    "codebase-retrieval": {
      "command": "codebase-retrieval",
      "args": []
    }
  }
}
```

## é…ç½®æ–‡ä»¶

é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨åˆ›å»ºé…ç½®æ–‡ä»¶ï¼š

```
%USERPROFILE%\.codebase-mcp\settings.toml
```

## å¯é€‰ï¼šå¯ç”¨ Web ç®¡ç†ç•Œé¢

```bash
codebase-retrieval --web-port 8091
```

è®¿é—® http://localhost:8091 æŸ¥çœ‹ç®¡ç†ç•Œé¢ã€‚

## å¸è½½

```powershell
.\install-windows.ps1 -Uninstall
```

## æ•…éšœæ’é™¤

æŸ¥çœ‹æ—¥å¿—ï¼š

```
%USERPROFILE%\.codebase-mcp\log\codebase-mcp.log
```

## ç‰ˆæœ¬ä¿¡æ¯

- Version: ${{ github.ref_name || inputs.version }}
- Build: ${{ github.sha }}
"@ | Out-File -FilePath "$portableDir/README.md" -Encoding UTF8
          
          Write-Host "âœ“ Portable package created" -ForegroundColor Green
      
      - name: Create ZIP archive
        shell: pwsh
        run: |
          $portableDir = "packages/retrieval/build/portable"
          $zipFile = "packages/retrieval/build/codebase-retrieval-win-x64-portable.zip"
          
          Compress-Archive -Path "$portableDir/*" -DestinationPath $zipFile -Force
          
          $size = [math]::Round((Get-Item $zipFile).Length/1MB, 2)
          Write-Host "âœ“ ZIP created: $zipFile ($size MB)" -ForegroundColor Green
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: |
            packages/retrieval/build/pkg/*.exe
            packages/retrieval/build/*.zip
          retention-days: 7
      
      - name: Create Release (if tag)
        if: startsWith(github.ref, 'refs/tags/retrieval-exe-v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            packages/retrieval/build/pkg/*.exe
            packages/retrieval/build/*.zip
          draft: false
          prerelease: false
          name: Codebase Retrieval EXE ${{ github.ref_name }}
          body: |
            ## ğŸš€ Codebase Retrieval - Windows ä¾¿æºç‰ˆ
            
            ### ğŸ“¥ ä¸‹è½½
            
            **ä¾¿æºç‰ˆ ZIP**ï¼ˆæ¨èï¼‰:
            - `codebase-retrieval-win-x64-portable.zip` - åŒ…å« exe + å®‰è£…è„šæœ¬ + è¯´æ˜æ–‡æ¡£
            
            **å•ç‹¬ EXE**:
            - `codebase-retrieval-win-x64.exe` - ä»…å¯æ‰§è¡Œæ–‡ä»¶
            
            ### âœ¨ åŠŸèƒ½ç‰¹æ€§
            
            - âœ… æ— éœ€ Node.js ç¯å¢ƒ
            - âœ… å•ä¸ª exe æ–‡ä»¶ï¼Œå¼€ç®±å³ç”¨
            - âœ… æ”¯æŒæ³¨å†Œåˆ°ç³»ç»Ÿç¯å¢ƒå˜é‡
            - âœ… æä¾› `codebase-retrieval` MCP å·¥å…·
            - âœ… è¯­ä¹‰ä»£ç æœç´¢
            - âœ… å¢é‡ç´¢å¼•ï¼ˆSHA-256 å»é‡ï¼‰
            - âœ… è·¨å¹³å°è·¯å¾„æ”¯æŒï¼ˆWindows/WSL/Unixï¼‰
            - âœ… å¯é€‰ Web ç®¡ç†ç•Œé¢
            
            ### ğŸ”§ ä½¿ç”¨æ–¹æ³•
            
            #### æ–¹æ³• 1ï¼šå¿«é€Ÿä½¿ç”¨ï¼ˆæ— éœ€å®‰è£…ï¼‰
            
            1. ä¸‹è½½å¹¶è§£å‹ `codebase-retrieval-win-x64-portable.zip`
            2. åœ¨ MCP å®¢æˆ·ç«¯é…ç½®ä¸­ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼š
            
            ```json
            {
              "mcpServers": {
                "codebase-retrieval": {
                  "command": "C:\\path\\to\\codebase-retrieval.exe"
                }
              }
            }
            ```
            
            #### æ–¹æ³• 2ï¼šå®‰è£…åˆ°ç³»ç»Ÿï¼ˆæ¨èï¼‰
            
            1. ä¸‹è½½å¹¶è§£å‹ `codebase-retrieval-win-x64-portable.zip`
            2. ä»¥ç®¡ç†å‘˜æƒé™è¿è¡Œ PowerShell
            3. æ‰§è¡Œå®‰è£…è„šæœ¬ï¼š
            
            ```powershell
            cd path\to\extracted\folder
            .\install-windows.ps1
            ```
            
            4. é‡æ–°æ‰“å¼€ç»ˆç«¯ï¼ŒéªŒè¯å®‰è£…ï¼š
            
            ```bash
            codebase-retrieval --help
            ```
            
            5. åœ¨ MCP å®¢æˆ·ç«¯é…ç½®ä¸­ä½¿ç”¨å‘½ä»¤åï¼š
            
            ```json
            {
              "mcpServers": {
                "codebase-retrieval": {
                  "command": "codebase-retrieval"
                }
              }
            }
            ```
            
            ### âš™ï¸ é…ç½®
            
            é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨åˆ›å»ºé…ç½®æ–‡ä»¶ï¼š
            ```
            %USERPROFILE%\.codebase-mcp\settings.toml
            ```
            
            å¯ä»¥æ‰‹åŠ¨ç¼–è¾‘æˆ–é€šè¿‡ Web ç•Œé¢ä¿®æ”¹ï¼ˆä½¿ç”¨ `--web-port 8091` å¯åŠ¨ï¼‰ã€‚
            
            ### ğŸ› æ•…éšœæ’é™¤
            
            **æŸ¥çœ‹æ—¥å¿—**:
            ```
            %USERPROFILE%\.codebase-mcp\log\codebase-mcp.log
            ```
            
            **æµ‹è¯• exe**:
            ```bash
            codebase-retrieval --web-port 8091
            ```
            
            è®¿é—® http://localhost:8091 æŸ¥çœ‹ç®¡ç†ç•Œé¢ã€‚
            
            **å¸è½½**:
            ```powershell
            .\install-windows.ps1 -Uninstall
            ```
            
            ### ğŸ“– æ–‡æ¡£
            
            - [README.md](https://github.com/${{ github.repository }}/blob/main/packages/retrieval/README.md)
            - [MCP é…ç½®ç¤ºä¾‹](https://github.com/${{ github.repository }}/blob/main/MCP_CONFIG_EXAMPLE.md)
            
            ---
            **ç‰ˆæœ¬**: `${{ github.ref_name }}`  
            **æäº¤**: `${{ github.sha }}`  
            **æ„å»ºæ—¶é—´**: `${{ github.event.head_commit.timestamp }}`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
